# """Exploitation router - HTTP endpoints for Snipers service."""
# import json
# from fastapi import APIRouter
# from fastapi.responses import StreamingResponse
# from typing import Any, AsyncGenerator, Dict, List

# from services.snipers.entrypoint import execute_exploit, execute_exploit_stream
# from services.snipers.models import (
#     AttackMode,
#     ProbeCategory,
#     ExploitStreamRequest as InternalExploitStreamRequest,
# )
# from services.api_gateway.schemas import (
#     ExploitStartRequest,
#     ExploitStreamRequest,
#     AttackModeAPI,
#     ProbeCategoryAPI,
# )

# router = APIRouter(prefix="/exploit", tags=["exploitation"])


# def _map_api_mode_to_internal(mode: AttackModeAPI) -> AttackMode:
#     """Map API mode enum to internal mode enum."""
#     mapping = {
#         AttackModeAPI.GUIDED: AttackMode.GUIDED,
#         AttackModeAPI.MANUAL: AttackMode.MANUAL,
#         AttackModeAPI.SWEEP: AttackMode.SWEEP,
#     }
#     return mapping[mode]


# def _map_api_categories_to_internal(
#     categories: List[ProbeCategoryAPI] | None,
# ) -> List[ProbeCategory] | None:
#     """Map API category enums to internal category enums."""
#     if categories is None:
#         return None
#     mapping = {
#         ProbeCategoryAPI.JAILBREAK: ProbeCategory.JAILBREAK,
#         ProbeCategoryAPI.PROMPT_INJECTION: ProbeCategory.PROMPT_INJECTION,
#         ProbeCategoryAPI.ENCODING: ProbeCategory.ENCODING,
#         ProbeCategoryAPI.DATA_EXTRACTION: ProbeCategory.DATA_EXTRACTION,
#         ProbeCategoryAPI.TOOL_EXPLOITATION: ProbeCategory.TOOL_EXPLOITATION,
#     }
#     return [mapping[c] for c in categories]


# @router.post("/start")
# async def start_exploit(request: ExploitStartRequest) -> Dict[str, Any]:
#     """Start exploitation for a campaign (legacy endpoint).

#     Requires recon and garak scans to be completed first.
#     Loads intelligence from S3 automatically.

#     Returns:
#         Exploit results with scan_id
#     """
#     result = await execute_exploit(
#         campaign_id=request.campaign_id,
#         target_url=request.target_url,
#         probe_name=request.probe_name,
#     )
#     return result


# @router.post("/start/stream")
# async def start_exploit_stream(request: ExploitStreamRequest) -> StreamingResponse:
#     """Start exploitation with real-time SSE streaming.

#     Supports three attack modes:
#     - guided: Uses Garak findings for pattern-learning attacks
#     - manual: Custom payload with optional converter chain
#     - sweep: All probes in selected categories

#     Returns Server-Sent Events with attack progress and results.
#     """
#     # Convert API request to internal request format
#     internal_request = InternalExploitStreamRequest(
#         target_url=request.target_url,
#         mode=_map_api_mode_to_internal(request.mode),
#         campaign_id=request.campaign_id,
#         custom_payload=request.custom_payload,
#         converters=request.converters,
#         categories=_map_api_categories_to_internal(request.categories),
#         probes_per_category=request.probes_per_category,
#         probe_name=request.probe_name,
#         require_plan_approval=request.require_plan_approval,
#     )

#     async def event_generator() -> AsyncGenerator[str, None]:
#         async for event in execute_exploit_stream(internal_request):
#             yield f"data: {event.model_dump_json()}\n\n"

#     return StreamingResponse(
#         event_generator(),
#         media_type="text/event-stream",
#         headers={
#             "Cache-Control": "no-cache",
#             "Connection": "keep-alive",
#             "X-Accel-Buffering": "no",
#         },
#     )


# @router.get("/converters")
# async def get_available_converters() -> Dict[str, Any]:
#     """Get list of available PyRIT converters.

#     Returns:
#         Dict with converter names and descriptions
#     """
#     from services.snipers.core.probe_registry import (
#         AVAILABLE_CONVERTERS,
#         CONVERTER_DESCRIPTIONS,
#     )

#     return {
#         "converters": AVAILABLE_CONVERTERS,
#         "descriptions": CONVERTER_DESCRIPTIONS,
#     }


# @router.get("/categories")
# async def get_probe_categories() -> Dict[str, Any]:
#     """Get list of probe categories and their probes.

#     Returns:
#         Dict with categories and associated probes
#     """
#     from services.snipers.core.probe_registry import PROBE_CATEGORIES

#     return {
#         "categories": {cat.value: probes for cat, probes in PROBE_CATEGORIES.items()},
#     }
