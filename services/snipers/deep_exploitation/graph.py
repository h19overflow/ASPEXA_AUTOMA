"""
Deep Exploitation Graph.

Purpose: Create deep agent orchestrator with subagent delegation
Role: Main agent that coordinates adaptive attacks via task() tool
Dependencies: deepagents, subagents, tools

Architecture (Deep Agents Pattern):
    ┌─────────────────────────────────────────────────────────────┐
    │                    Orchestrator Agent                        │
    │                  (create_deep_agent)                         │
    │                                                              │
    │  Tools:                    Subagents (via task):             │
    │  - execute_attack          - response-analyzer               │
    │                            - failure-analyzer                │
    │                            - chain-discovery                 │
    │                            - strategy-generator              │
    └─────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
                        LLM decides dynamically:
                        1. Execute attack
                        2. If failed → delegate analysis
                        3. Get new chain + strategy
                        4. Loop until success/exhausted
"""
import logging
from typing import Any

from deepagents import create_deep_agent

from services.snipers.deep_exploitation.prompts import ORCHESTRATOR_SYSTEM_PROMPT
from services.snipers.deep_exploitation.subagents import get_all_subagents
from services.snipers.deep_exploitation.tools import get_orchestrator_tools
from dotenv import load_dotenv
load_dotenv()
logger = logging.getLogger(__name__)


def build_deep_exploitation_agent(
    model: str = "google_genai:gemini-2.5-pro",
) -> Any:
    """
    Build the deep exploitation orchestrator agent.

    This creates a deep agent with:
    - execute_attack tool for running attacks
    - Subagents for analysis and strategy generation
    - System prompt guiding the attack coordination

    Args:
        model: Model identifier for the orchestrator

    Returns:
        Compiled deep agent ready for invocation
    """
    logger.info("Building deep exploitation orchestrator agent")
    logger.info(f"  Model: {model}")

    # Get tools and subagents
    tools = get_orchestrator_tools()
    subagents = get_all_subagents()

    logger.info(f"  Tools: {[t.name for t in tools]}")
    logger.info(f"  Subagents: {[s['name'] for s in subagents]}")

    # Create deep agent
    agent = create_deep_agent(
        model=model,
        system_prompt=ORCHESTRATOR_SYSTEM_PROMPT,
        tools=tools,
        subagents=subagents,
    )

    logger.info("  Deep agent created successfully")
    return agent


def compile_graph() -> Any:
    """
    Build and compile the deep exploitation agent.

    Returns:
        Compiled agent ready for invocation
    """
    return build_deep_exploitation_agent()


# =============================================================================
# Legacy Support: Keep old graph builder for backwards compatibility
# =============================================================================

def build_deep_exploitation_graph():
    """
    Legacy function - now returns a deep agent instead of StateGraph.

    This is kept for backwards compatibility but returns a deep agent
    that can be invoked the same way.
    """
    logger.warning(
        "build_deep_exploitation_graph() is deprecated. "
        "Use build_deep_exploitation_agent() instead."
    )
    return build_deep_exploitation_agent()
