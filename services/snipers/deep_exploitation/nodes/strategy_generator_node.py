"""
Strategy Generator Node.

Purpose: LLM-powered adaptation strategy generation
Role: Generates overall strategy including framing and payload guidance
Dependencies: StrategyGenerator component (LLM-powered)

Context Size: ~3KB input, ~1KB output
"""
import logging
from typing import Any

from libs.monitoring import CallbackHandler
from services.snipers.deep_exploitation.state import DeepExploitationState
from services.snipers.adaptive_attack.components.strategy_generator import (
    StrategyGenerator,
)

logger = logging.getLogger(__name__)


async def strategy_generator_node(
    state: DeepExploitationState,
) -> dict[str, Any]:
    """
    Generate overall adaptation strategy via LLM.

    This node produces framing decisions, payload guidance,
    and reasoning for the current iteration.

    Args:
        state: Current state with response_analysis, chain candidates, etc.

    Returns:
        State update with adaptation_decision, custom_framing, preset_framing, payload_guidance
    """
    iteration = state.get("iteration", 0)
    responses = state.get("target_responses", [])
    response_analysis = state.get("response_analysis", {})
    iteration_history = state.get("iteration_history", [])
    tried_framings = state.get("tried_framings", [])
    tried_converters = state.get("tried_converters", [])
    phase1_result = state.get("phase1_result")

    # Extract objective
    objective = "test security boundaries"
    if phase1_result and hasattr(phase1_result, "garak_objective"):
        objective = phase1_result.garak_objective or objective

    logger.info(f"[StrategyGenerator] Iteration {iteration}: Generating strategy")

    try:
        # Use existing StrategyGenerator
        generator = StrategyGenerator()
        handler = CallbackHandler()

        # Extract recon intelligence if available
        recon_intelligence = None
        if phase1_result and hasattr(phase1_result, "context_summary"):
            context_summary = phase1_result.context_summary
            if isinstance(context_summary, dict):
                recon_intelligence = context_summary.get("recon_intelligence")

        config = {
            "callbacks": [handler],
            "run_name": "DeepStrategyGenerator",
        }
        if recon_intelligence:
            config["recon_intelligence"] = recon_intelligence
            logger.info(f"  Using recon intelligence")

        decision = await generator.generate(
            responses=responses,
            iteration_history=iteration_history,
            tried_framings=tried_framings,
            tried_converters=tried_converters,
            objective=objective,
            pre_analysis=response_analysis,
            config=config,
        )

        logger.info(f"  Custom framing: {decision.use_custom_framing}")
        logger.info(f"  Confidence: {decision.confidence:.2f}")

        # Build framing dict
        custom_framing_dict = None
        if decision.use_custom_framing and decision.custom_framing:
            custom_framing_dict = {
                "name": decision.custom_framing.name,
                "system_context": decision.custom_framing.system_context,
                "user_prefix": decision.custom_framing.user_prefix,
                "user_suffix": decision.custom_framing.user_suffix,
            }

        # Build recon framing dict
        recon_custom_framing_dict = None
        if decision.recon_custom_framing:
            recon_custom_framing_dict = {
                "role": decision.recon_custom_framing.role,
                "context": decision.recon_custom_framing.context,
                "justification": decision.recon_custom_framing.justification,
            }

        return {
            "adaptation_decision": decision,
            "custom_framing": custom_framing_dict,
            "recon_custom_framing": recon_custom_framing_dict,
            "preset_framing": decision.preset_framing if not decision.use_custom_framing else None,
            "payload_guidance": decision.payload_adjustments,
        }

    except Exception as e:
        logger.error(f"  Strategy generation failed: {e}")
        # Fallback to preset framing
        return {
            "adaptation_decision": None,
            "custom_framing": None,
            "recon_custom_framing": None,
            "preset_framing": "qa_testing",
            "payload_guidance": "Use default payload generation",
            "error": f"Strategy generation error: {str(e)[:200]}",
        }
