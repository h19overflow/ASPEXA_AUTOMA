import re

with open('viper-command-center/src/components/scan-viewers/ExploitResultViewer.tsx', 'r', encoding='utf-8') as f:
    content = f.read()

# Make sure we add 'snipers: true' to expandedSections
content = re.sub(
    r'adaptive: true,\n  \}\);',
    r'adaptive: true,\n    snipers: true,\n  });',
    content
)

# Insert the new Snipers section right before the Compliance Metrics Section
snipers_section = """
        {/* Snipers Attack Results (New Format) */}
        {data.phase3 && (
          <Collapsible open={expandedSections.snipers} onOpenChange={() => toggleSection("snipers")}>
            <Card className="border-border rounded-xl bg-card">
              <CollapsibleTrigger asChild>
                <div className="flex items-center justify-between p-4 cursor-pointer hover:bg-card transition-colors rounded-t-xl">
                  <div className="flex items-center gap-2">
                    <Shield className="w-5 h-5 text-primary" />
                    <h3 className="font-semibold text-foreground">Sniper Attack Results</h3>
                    <Badge className="ml-2 bg-card border-border text-foreground/60 rounded-full">
                      {(data.phase3 as any).attack_responses?.length || 0} payloads
                    </Badge>
                  </div>
                  <ChevronDown className={`w-4 h-4 text-foreground/40 transition-transform ${expandedSections.snipers ? "rotate-180" : ""}`} />
                </div>
              </CollapsibleTrigger>
              <CollapsibleContent>
                <Separator className="bg-primary/20" />
                <div className="p-4 space-y-4">
                  
                  {/* Score overview */}
                  {(data.phase3 as any).composite_score && (
                    <div className="grid grid-cols-2 gap-4">
                      <div className="p-4 bg-card border border-border rounded-xl flex items-center justify-between">
                         <div>
                           <p className="text-xs text-foreground/40">Overall Severity</p>
                           <p className={`font-mono text-xl font-bold ${(data.phase3 as any).composite_score.overall_severity === 'critical' ? 'text-red-500' : (data.phase3 as any).composite_score.overall_severity === 'high' ? 'text-orange-500' : 'text-primary'}`}>
                             {((data.phase3 as any).composite_score.overall_severity || "NONE").toUpperCase()}
                           </p>
                         </div>
                         <Activity className="w-8 h-8 text-primary opacity-20" />
                      </div>
                      <div className="p-4 bg-card border border-border rounded-xl flex items-center justify-between">
                         <div>
                           <p className="text-xs text-foreground/40">Total Score</p>
                           <p className="font-mono text-xl text-emerald-400 font-bold">
                             {((data.phase3 as any).composite_score.total_score || 0).toFixed(1)} / 100
                           </p>
                         </div>
                         <Target className="w-8 h-8 text-emerald-400 opacity-20" />
                      </div>
                    </div>
                  )}

                  {/* Scorer Details */}
                  {(data.phase3 as any).composite_score?.scorer_results && Object.keys((data.phase3 as any).composite_score.scorer_results).length > 0 && (
                     <div className="space-y-2 mt-4">
                       <p className="text-xs text-foreground/40">Scorer Diagnostics</p>
                       <div className="grid grid-cols-2 gap-2">
                         {Object.entries((data.phase3 as any).composite_score.scorer_results).map(([scorerName, result]: [string, any]) => (
                           <div key={scorerName} className="p-3 bg-primary/10 border border-border rounded-lg">
                             <div className="flex justify-between items-center mb-1">
                                <span className="text-sm font-semibold capitalize text-foreground">{scorerName.replace('_', ' ')}</span>
                                <Badge className="text-xs bg-card border-border text-foreground/80">{result.severity?.toUpperCase()}</Badge>
                             </div>
                             <div className="flex justify-between items-center text-xs">
                                <span className="text-foreground/40">Confidence</span>
                                <span className="text-primary font-mono">{(result.confidence * 100).toFixed(0)}%</span>
                             </div>
                             {result.reasoning && (
                                <p className="mt-2 text-xs text-foreground/60 italic">{result.reasoning}</p>
                             )}
                           </div>
                         ))}
                       </div>
                     </div>
                  )}

                  {/* Attack Responses */}
                  {(data.phase3 as any).attack_responses && (data.phase3 as any).attack_responses.length > 0 && (
                    <div className="mt-6 space-y-4">
                      <p className="text-xs text-foreground/40">Attack Transcripts</p>
                      {(data.phase3 as any).attack_responses.map((resp: any, idx: number) => (
                        <Card key={idx} className="p-4 bg-black/20 border border-border rounded-xl">
                          <div className="flex justify-between items-center mb-2">
                            <Badge className="bg-primary/20 text-primary border-border">Payload {resp.payload_index ?? idx + 1}</Badge>
                            <span className="text-xs text-foreground/40">{resp.latency_ms}ms | Status {resp.status_code}</span>
                          </div>
                          
                          <div className="space-y-3">
                            <div>
                               <div className="flex items-center justify-between mb-1">
                                 <p className="text-xs text-amber-400 flex items-center gap-1"><Zap className="w-3 h-3"/> Payload</p>
                                 <Button variant="ghost" size="sm" className="h-5 text-[10px] text-foreground/40 hover:text-foreground hover:bg-card" onClick={(e) => { e.stopPropagation(); navigator.clipboard.writeText(resp.payload); }}>
                                   <Copy className="w-3 h-3 mr-1" /> Copy
                                 </Button>
                               </div>
                               <pre className="text-xs font-mono text-foreground/80 whitespace-pre-wrap p-3 bg-black/40 rounded-lg border border-border overflow-x-auto max-h-40">{resp.payload}</pre>
                            </div>
                            <div>
                               <div className="flex items-center justify-between mb-1">
                                 <p className="text-xs text-emerald-400 flex items-center gap-1"><MessageSquare className="w-3 h-3"/> Response</p>
                                 <Button variant="ghost" size="sm" className="h-5 text-[10px] text-foreground/40 hover:text-foreground hover:bg-card" onClick={(e) => { e.stopPropagation(); navigator.clipboard.writeText(resp.response); }}>
                                   <Copy className="w-3 h-3 mr-1" /> Copy
                                 </Button>
                               </div>
                               <pre className="text-xs font-mono text-foreground/80 whitespace-pre-wrap p-3 bg-black/40 rounded-lg border border-border overflow-x-auto max-h-40">{resp.response}</pre>
                            </div>
                            {resp.error && (
                               <div>
                                 <p className="text-xs text-red-400 mb-1 flex items-center gap-1"><AlertTriangle className="w-3 h-3"/> Error</p>
                                 <pre className="text-xs font-mono text-red-400/80 whitespace-pre-wrap p-3 bg-red-500/10 rounded-lg border border-red-500/30 overflow-x-auto max-h-40">{resp.error}</pr
